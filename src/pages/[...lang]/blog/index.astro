---
import BlogLayout from "../../../layouts/BlogLayout.astro";
import { getLangFromUrl, useTranslations } from "../../../i18n/locales";

export function getStaticPaths() {
  return [
    { params: { lang: undefined } },
    { params: { lang: "en" } },
    { params: { lang: "pt" } },
  ];
}

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Get all posts and filter by language
const allPosts = await Astro.glob("../../../content/blog/**/*.md");
const posts = allPosts.filter((post) => {
  const path = post.file;
  if (lang === "es") {
    return !path.includes("/en/") && !path.includes("/pt/");
  }
  return path.includes(`/${lang}/`);
});

const sortedPosts = posts.sort((a, b) => {
  return (
    new Date(b.frontmatter.date).getTime() -
    new Date(a.frontmatter.date).getTime()
  );
});

const visiblePosts = sortedPosts.slice(0, 4);
---

<BlogLayout title="Blog">
  <div class="posts-list">
    <h2 class="blog-title">{t("blog.title")}</h2>

    {
      visiblePosts.length > 0 ? (
        visiblePosts.map((post) => (
          <a
            href={
              lang === "es"
                ? `/blog/${post.frontmatter.slug || "post"}`
                : `/${lang}/blog/${post.frontmatter.slug || "post"}`
            }
            class="post-link"
          >
            <article class="post-preview">
              <time class="post-date">
                {new Date(post.frontmatter.date).toLocaleDateString(
                  lang === "es" ? "es-ES" : lang === "pt" ? "pt-BR" : "en-US",
                  {
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                  }
                )}
              </time>
              <h3 class="post-title">{post.frontmatter.title}</h3>
              <p class="post-excerpt">{post.frontmatter.excerpt}</p>
            </article>
          </a>
        ))
      ) : (
        <p class="no-posts">{t("blog.noPosts")}</p>
      )
    }

    {
      sortedPosts.length > 4 && (
        <div class="view-more">
          <a
            href={lang === "es" ? "/blog/todas" : `/${lang}/blog/all`}
            class="view-more-link"
          >
            {t("blog.viewMore")}
          </a>
        </div>
      )
    }
  </div>
</BlogLayout>

<style>
  .posts-list {
    max-width: 600px;
  }

  .blog-title {
    font-size: 1.5rem;
    font-weight: 400;
    margin-bottom: 3rem;
    letter-spacing: 0.05em;
    color: var(--text);
  }

  .post-link {
    display: block;
    text-decoration: none;
    color: inherit;
    transition: opacity 0.2s ease;
  }

  .post-link:hover {
    opacity: 0.9;
  }

  .post-preview {
    margin-bottom: 3rem;
    padding: 1.5rem;
    border-radius: 4px;
    background: rgba(255, 255, 255, 0.5);
    transition: background 0.2s ease;
  }

  .post-link:hover .post-preview {
    background: rgba(255, 255, 255, 0.8);
  }

  .post-date {
    font-size: 0.875rem;
    color: var(--text-light);
    letter-spacing: 0.02em;
  }

  .post-title {
    font-size: 1.25rem;
    font-weight: 400;
    margin: 0.5rem 0 1rem 0;
    color: var(--text);
  }

  .post-excerpt {
    font-size: 0.95rem;
    line-height: 1.6;
    color: var(--text-light);
  }

  .no-posts {
    color: var(--text-light);
    font-style: italic;
  }

  .view-more {
    text-align: center;
    margin-top: 2rem;
  }

  .view-more-link {
    color: var(--text);
    text-decoration: none;
    font-size: 1rem;
    letter-spacing: 0.05em;
    transition: opacity 0.3s ease;
    padding: 0.75rem 2rem;
    border: 1px solid var(--text);
    display: inline-block;
    border-radius: 4px;
  }

  .view-more-link:hover {
    opacity: 0.7;
  }

  @media (max-width: 768px) {
    .blog-title {
      font-size: 1.25rem;
      margin-bottom: 2rem;
    }

    .post-preview {
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
    }
  }
</style>
